---
title: 'Using SafeQL with unsupported GIS features'
metaTitle: 'Using SafeQL with unsupported GIS features (Guide)'
metaDescription: 'Learn how to use SafeQL and Prisma Client extensions to work around features not natively supported by Prisma.'
---

## Overview

This page explains how to use Prisma Client extensions and [SafeQL](https://safeql.dev) in order to make the experience of working with geographic data better.

Our example will be using [PostGIS](https://postgis.net/) and PostgreSQL, but is applicable to other features and database engines.

## Prerequisites

To follow this guide, we recommend:

- an existing [PostgreSQL](https://www.postgresql.org/) database
- an existing Prisma project

## What is SafeQL?

[SafeQL](https://safeql.dev/) is an ESLint plugin that allows for advanced linting and type safety within raw SQL queries. After setup, SafeQL works with Prisma `$queryRaw` and `$executeRaw` to provide type safety when raw queries are required.

## Geographic data support in Prisma

At this time geographic data, and specifically PostGIS, are not supported by Prisma. Models that have geographic data columns will not have the benefit of type safety, nor will be able to use mutating operations like `create` and `update`.

Prisma does support operations using `$queryRaw` and `$executeRaw` and we will be using these in order to create a Prisma Client extension with SafeQL to improve the usage of geographic data in Prisma.

## 1. Set up Prisma for use with PostGIS

If you haven't already, update your Prisma schema to add the `postgis` PostgreSQL extension

```prisma
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis]
}
```

Then, create a migration using `npx prisma migrate dev` in order to enable the extension. The migration file should look like the following:

```sql

-- CreateExtension
CREATE EXTENSION IF NOT EXISTS "postgis";

```

Make sure that the migration is applied!

## 2. Create a new model that uses a geographic data column

After the migration is applied, you can now add a new model that has a GIS column. For our example we'll be using the following `PointOfInterest` model.

```prisma
model PointOfInterest {
  id       Int                                   @id @default(autoincrement())
  name     String
  location Unsupported("geography(Point, 4326)")
}
```

You'll notice that `location` is marked as `Unsupported`. This means that we lose a lot of the benefits of Prisma when working with `PointOfInterest`. We'll be using [SafeQL](https://safeql.dev/) to fix this.

Create a new migration with `npx prisma migrate dev` and apply it to add the `PointOfInterest` table to our database.

## 3. Integrate SafeQL

SafeQL is easily integrated with Prisma. Follow [SafeQL's integration guide](https://safeql.dev/compatibility/prisma.html) in order to lint `$queryRaw` and `$executeRaw` Prisma calls.

<Admonition>

Note that for SafeQL to run it will need to have access to your database. We recommend passing the same environment variable or connection string that is used by Prisma.

</Admonition>

## 4. Creating an extension for geographic data

Now let's make a Prisma Client extension in order to query this model. We will be making an extension that finds the closest points of interest to a given longitude and latitude.

```ts file=lib/db.ts
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient().$extends((client) => {
  return client.$extends({
    model: {
      pointOfInterest: {
        async findClosestPoints(
          latitude: Number,
          longitude: Number,
          limit: Number
        ) {
          return client.$queryRaw<
            { id: number; name: string; location: string }[]
          >`SELECT * FROM "PointOfInterest" ORDER BY ST_DistanceSphere(location::geometry, ST_MakePoint(${longitude}, ${latitude})) LIMIT ${limit}`
        },
      },
    },
  })
})

export { prisma }
```

Now we can use our Prisma Client as normal in order to find close points of interest to a given longitude and latitude!

```ts file=app.ts
const closestPointOfInterest = await prisma.pointOfInterest.findClosestPoints(
  myLatitude,
  myLongitude,
  1
)
```

We also have the benefit of SafeQL to add extra type safety to our raw queries. For example, if we removed the cast to `geometry` for `location`, we would get the linting error:

```terminal
error  Invalid Query: function st_distancesphere(geography, geometry) does not exist  @ts-safeql/check-sql
```

Which would let us know to check our function signature again.
